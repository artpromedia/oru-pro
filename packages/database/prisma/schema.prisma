generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Facility {
  id          String      @id @default(cuid())
  name        String
  timezone    String      @default("UTC")
  inventory   Inventory[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model Inventory {
  id           String   @id @default(cuid())
  facility     Facility @relation(fields: [facilityId], references: [id])
  facilityId   String
  sku          String
  quantityOnHand Float
  quantityOnHold Float   @default(0)
  uom          String
  qaState      String    @default("released")
  updatedAt    DateTime  @updatedAt
  createdAt    DateTime  @default(now())
}

model ProductionOrder {
  id          String   @id @default(cuid())
  bomCode     String
  status      String   @default("planned")
  plannedDate DateTime
  actualDate  DateTime?
}

model AgentHeartbeat {
  id         String   @id @default(cuid())
  agentName  String
  queueName  String
  status     String
  payload    Json
  createdAt  DateTime @default(now())
}

model Organization {
  id        String   @id @default(cuid())
  code      String?  @unique
  name      String
  status    String   @default("active")
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        User[]
  roles        Role[]
  channels     Channel[]
  notifications Notification[]
}

model Role {
  id              String         @id @default(cuid())
  organization    Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId  String
  name            String
  description     String?
  permissions     String[]
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  users           User[]

  @@unique([organizationId, name])
}

model User {
  id              String         @id @default(cuid())
  organization    Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId  String
  email           String         @unique
  passwordHash    String?
  name            String
  avatarUrl       String?
  title           String?
  status          String         @default("active")
  settings        Json?
  role            Role?          @relation(fields: [roleId], references: [id])
  roleId          String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  messages        Message[]
  reactions       MessageReaction[]
  memberships     ChannelMember[]
  notifications   Notification[]
  initiatedCalls  Call[]         @relation("CallInitiator")
}

model Notification {
  id        String   @id @default(cuid())
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  type      String
  title     String
  message   String
  data      Json?
  status    String   @default("unread")
  readAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId, status])
  @@index([organizationId])
}

model Channel {
  id              String         @id @default(cuid())
  organization    Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId  String
  name            String
  slug            String
  type            String         @default("channel")
  description     String?
  isPrivate       Boolean        @default(false)
  topic           String?
  createdBy       String
  lastMessageId   String?
  lastActivity    DateTime?
  archived        Boolean        @default(false)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  members         ChannelMember[]
  messages        Message[]
  calls           Call[]

  @@unique([organizationId, slug])
  @@index([organizationId, type, archived])
}

model ChannelMember {
  id          String   @id @default(cuid())
  channel     Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  channelId   String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  role        String   @default("member")
  isMuted     Boolean  @default(false)
  lastReadAt  DateTime?
  unreadCount Int      @default(0)
  joinedAt    DateTime @default(now())

  @@unique([channelId, userId])
  @@index([userId])
}

model Message {
  id          String    @id @default(cuid())
  channel     Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade)
  channelId   String
  user        User      @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId      String
  content     String
  metadata    Json?
  isPinned    Boolean   @default(false)
  isRead      Boolean   @default(false)
  deleted     Boolean   @default(false)
  deletedAt   DateTime?
  deletedBy   String?
  edited      Boolean   @default(false)
  editedAt    DateTime?
  replyTo     Message?  @relation("MessageReplies", fields: [replyToId], references: [id])
  replyToId   String?
  replies     Message[] @relation("MessageReplies")
  attachments MessageAttachment[]
  reactions   MessageReaction[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([channelId, createdAt])
  @@index([replyToId])
}

model MessageAttachment {
  id         String   @id @default(cuid())
  message    Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId  String
  name       String?
  type       String?
  size       Int?
  url        String
  metadata   Json?
  uploadedBy String?
  createdAt  DateTime @default(now())
}

model MessageReaction {
  id        String   @id @default(cuid())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  emoji     String
  createdAt DateTime @default(now())

  @@unique([messageId, userId, emoji])
  @@index([messageId])
}

model Call {
  id           String   @id @default(cuid())
  channel      Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  channelId    String
  initiator    User?    @relation("CallInitiator", fields: [initiatorId], references: [id])
  initiatorId  String?
  type         String
  status       String   @default("ringing")
  startedAt    DateTime @default(now())
  endedAt      DateTime?
  metadata     Json?
}

// Automotive Manufacturing Extensions
model VehicleModel {
  id               String @id
  modelCode        String @unique
  platform         String
  modelYear        Int
  variant          String
  bom              Json
  assemblySequence Json
  taktTime         Int
  qualityGates     Json[]
}

model SupplyChainTier {
  id                  String  @id
  supplierCode        String
  tier                Int
  parts               String[]
  justInTime          Boolean
  kanbanSignals       Json
  ediIntegration      Boolean
  qualityRating       Decimal
  deliveryPerformance Decimal
  contingencySupplier String?
}

model ProductionLine {
  id             String @id
  lineCode       String
  stationType    String
  capacity       Int
  currentVIN     String?
  sequenceNumber Int
  andonStatus    String
  qualityDefects Json[]
  cycleTime      Int
}

model QualityGate {
  id             String @id
  gateNumber     Int
  gateName       String
  vin            String
  defects        Json[]
  reworkRequired Boolean
  passStatus     Boolean
  torqueData     Json[]
  gapFlushData   Json[]
}

model VehicleRecall {
  id            String  @id
  recallNumber  String
  affectedVINs  String[]
  component     String
  supplier      String
  safetyRisk    String
  remediation   String
  nhtsaCampaign String?
}

// Healthcare Provider Extensions
model PatientFlow {
  id                   String  @id
  patientId            String
  admissionType        String
  department           String
  bedAssignment        String?
  acuityLevel          Int
  lengthOfStay         Int?
  dischargeDisposition String?
  readmissionRisk      Float
}

model MedicalSupplies {
  id               String   @id
  itemCode         String   @unique
  category         String
  parLevel         Int
  currentStock     Int
  expiryTracked    Boolean
  lotNumbers       String[]
  implantable      Boolean
  fdaClass         String?
  sterilizationDate DateTime?
}

model OperatingRoom {
  id               String  @id
  orNumber         String
  status           String
  currentProcedure String?
  surgeonId        String?
  nextCase         DateTime?
  utilizationRate  Decimal
  turnaroundTime   Int
  equipmentStatus  Json
}

model ClinicalPathway {
  id             String  @id
  pathwayName    String
  drg            String
  expectedLOS    Int
  steps          Json[]
  outcomes       Json
  costPerCase    Decimal
  qualityMetrics Json
}

// Logistics & Transportation Extensions
model Fleet {
  id              String  @id
  vehicleId       String  @unique
  type            String
  capacity        Json
  currentLocation Json
  status          String
  driver          String?
  fuelLevel       Float
  nextMaintenance DateTime
  iotTelemetry    Json
}

model Route {
  id                String @id
  routeNumber       String
  origin            String
  destination       String
  stops             Json[]
  distance          Float
  estimatedTime     Int
  actualTime        Int?
  fuelConsumption   Float
  trafficConditions String
  weatherImpact     String?
  optimization      Json
}

model CrossDock {
  id                String  @id
  facilityCode      String
  inboundShipments  Json[]
  outboundShipments Json[]
  sortingLanes      Int
  throughputRate    Int
  dwellTime         Int
  missortRate       Decimal
}

model LastMile {
  id                   String  @id
  deliveryId           String
  customerLocation     Json
  timeWindow           Json
  deliveryAttempts     Int
  proofOfDelivery      String?
  customerSatisfaction Int?
  deliveryCost         Decimal
  alternativeDelivery  String?
}

model Document {
  id          String   @id
  tenantId    String
  name        String
  type        String
  size        Int
  hash        String
  storageUrl  String
  uploadedBy  String
  status      String   @default("processing")
  category    String?
  tags        String[]
  aiExtracted Json?
  compliance  Json?
  version     Int      @default(1)
  locked      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, hash])
  @@index([tenantId, status])
}

model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  action    String
  entity    String
  entityId  String
  details   Json
  createdAt DateTime @default(now())

  @@index([tenantId, action])
}

model Tenant {
  id           String   @id @default(cuid())
  code         String   @unique
  name         String
  timezone     String   @default("UTC")
  baseCurrency String   @default("USD")
  sapSystem    String?
  plants       Plant[]
  materials    Material[]
  suppliers    Supplier[]
  alerts       InventoryAlert[]
  forecasts    ForecastSnapshot[]
  stocks       MaterialStock[]
  purchaseOrders PurchaseOrder[]
  materialDocuments MaterialDocument[]
  qualityLots  QualityLot[]
  handlingUnits HandlingUnit[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Plant {
  id                String            @id @default(cuid())
  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId          String
  code              String
  name              String
  region            String?
  timezone          String            @default("UTC")
  storageLocations  StorageLocation[]
  stocks            MaterialStock[]
  batches           MaterialBatch[]
  documents         MaterialDocument[]
  quality           QualityLot[]
  purchaseOrders    PurchaseOrder[]
  forecastSnapshots ForecastSnapshot[]
  alerts            InventoryAlert[]
  handlingUnits     HandlingUnit[]
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@unique([tenantId, code])
}

model StorageLocation {
  id              String   @id @default(cuid())
  plant           Plant    @relation(fields: [plantId], references: [id], onDelete: Cascade)
  plantId         String
  code            String
  description     String?
  temperatureBand String?
  capacity        Decimal?
  stocks          MaterialStock[]
  handlingUnits   HandlingUnit[]
  purchaseItems   PurchaseOrderItem[]
  materialDocuments MaterialDocument[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([plantId, code])
}

model Material {
  id                   String             @id @default(cuid())
  tenant               Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId             String
  materialNumber       String
  description          String
  materialGroup        String?
  baseUnit             String
  valuationClass       String?
  mrpType              String?
  abcIndicator         String?
  shelfLifeDays        Int?
  serializationRequired Boolean          @default(false)
  hazardClass          String?
  leadTimeDays         Int?
  netWeight            Decimal?
  stocks               MaterialStock[]
  batches              MaterialBatch[]
  purchaseItems        PurchaseOrderItem[]
  documents            MaterialDocument[]
  qualityLots          QualityLot[]
  forecasts            ForecastSnapshot[]
  handlingUnits        HandlingUnit[]
  alerts               InventoryAlert[]
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@unique([tenantId, materialNumber])
}

model MaterialBatch {
  id             String   @id @default(cuid())
  material       Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  materialId     String
  plant          Plant?   @relation(fields: [plantId], references: [id])
  plantId        String?
  batchNumber    String
  manufacturingDate DateTime?
  expiryDate     DateTime?
  status         String   @default("OPEN")
  characteristics Json?
  stocks         MaterialStock[]
  documents      MaterialDocument[]
  qualityLots    QualityLot[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([materialId, batchNumber])
}

model MaterialStock {
  id                String           @id @default(cuid())
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId          String
  material          Material         @relation(fields: [materialId], references: [id], onDelete: Cascade)
  materialId        String
  plant             Plant            @relation(fields: [plantId], references: [id], onDelete: Cascade)
  plantId           String
  storageLocation   StorageLocation? @relation(fields: [storageLocationId], references: [id])
  storageLocationId String?
  batch             MaterialBatch?   @relation(fields: [batchId], references: [id])
  batchId           String?
  uom               String
  availableQty      Decimal          @default(0)
  qualityQty        Decimal          @default(0)
  blockedQty        Decimal          @default(0)
  safetyStock       Decimal          @default(0)
  reorderPoint      Decimal          @default(0)
  status            String           @default("released")
  agingBucket       String?
  lastCountAt       DateTime?
  lastMovementAt    DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([tenantId, plantId, materialId])
  @@unique([tenantId, plantId, storageLocationId, materialId, batchId])
}

model Supplier {
  id          String          @id @default(cuid())
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId    String
  code        String
  name        String
  rating      Decimal?
  leadTimeDays Int?
  paymentTerms String?
  contact      Json?
  purchaseOrders PurchaseOrder[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, code])
}

model PurchaseOrder {
  id             String         @id @default(cuid())
  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId       String
  supplier       Supplier       @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  supplierId     String
  plant          Plant?         @relation(fields: [plantId], references: [id])
  plantId        String?
  documentNumber String
  status         String         @default("OPEN")
  incoterms      String?
  expectedDate   DateTime?
  currency       String?
  items          PurchaseOrderItem[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@unique([tenantId, documentNumber])
}

model PurchaseOrderItem {
  id               String        @id @default(cuid())
  purchaseOrder    PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  purchaseOrderId  String
  lineNumber       Int
  material         Material      @relation(fields: [materialId], references: [id], onDelete: Cascade)
  materialId       String
  orderedQty       Decimal
  receivedQty      Decimal        @default(0)
  uom              String
  netPrice         Decimal?
  currency         String?
  deliveryDate     DateTime?
  status           String         @default("OPEN")
  storageLocation  StorageLocation? @relation(fields: [storageLocationId], references: [id])
  storageLocationId String?
  batchRequirement Boolean        @default(false)
  confirmedDate    DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@unique([purchaseOrderId, lineNumber])
}

model MaterialDocument {
  id               String           @id @default(cuid())
  tenant           Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId         String
  documentNumber   String           @unique
  movementType     String
  material         Material         @relation(fields: [materialId], references: [id], onDelete: Cascade)
  materialId       String
  batch            MaterialBatch?   @relation(fields: [batchId], references: [id])
  batchId          String?
  plant            Plant            @relation(fields: [plantId], references: [id], onDelete: Cascade)
  plantId          String
  storageLocation  StorageLocation? @relation(fields: [storageLocationId], references: [id])
  storageLocationId String?
  quantity         Decimal
  uom              String
  reference        String?
  reasonCode       String?
  source           String?
  postedBy         String?
  postedAt         DateTime @default(now())
  metadata         Json?
}

model QualityLot {
  id          String   @id @default(cuid())
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId    String
  plant       Plant    @relation(fields: [plantId], references: [id], onDelete: Cascade)
  plantId     String
  material    Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  materialId  String
  batch       MaterialBatch? @relation(fields: [batchId], references: [id])
  batchId     String?
  inspectionType String?
  status      String   @default("PENDING")
  holdReason  String?
  releasedQty Decimal  @default(0)
  rejectedQty Decimal  @default(0)
  inspector   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId, status])
}

model HandlingUnit {
  id               String           @id @default(cuid())
  tenant           Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId         String
  huNumber         String
  plant            Plant?           @relation(fields: [plantId], references: [id])
  plantId          String?
  storageLocation  StorageLocation? @relation(fields: [storageLocationId], references: [id])
  storageLocationId String?
  material         Material?        @relation(fields: [materialId], references: [id])
  materialId       String?
  quantity         Decimal?
  uom              String?
  weightKg         Decimal?
  status           String           @default("IDLE")
  metadata         Json?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@unique([tenantId, huNumber])
}

model ForecastSnapshot {
  id          String   @id @default(cuid())
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId    String
  material    Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  materialId  String
  plant       Plant?   @relation(fields: [plantId], references: [id])
  plantId     String?
  horizon     String
  method      String
  payload     Json
  generatedAt DateTime @default(now())
}

model InventoryAlert {
  id            String   @id @default(cuid())
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId      String
  material      Material? @relation(fields: [materialId], references: [id])
  materialId    String?
  plant         Plant?   @relation(fields: [plantId], references: [id])
  plantId       String?
  alertType     String
  severity      String   @default("medium")
  message       String
  source        String?
  acknowledged  Boolean  @default(false)
  createdAt     DateTime @default(now())
  resolvedAt    DateTime?

  @@index([tenantId, alertType])
}
