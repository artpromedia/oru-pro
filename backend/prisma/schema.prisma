generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Organization & User Management
model Organization {
  id        String   @id @default(cuid())
  name      String
  plan      String   @default("trial")
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  users         User[]
  warehouses    Warehouse[]
  inventories   Inventory[]
  productions   Production[]
  procurements  Procurement[]
  projects      Project[]
  decisions     Decision[]
  agents        Agent[]
  commsChannels CommsChannel[]
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  password       String
  name           String
  role           Role     @relation(fields: [roleId], references: [id])
  roleId         String
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String
  settings       Json?
  lastLogin      DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  decisions      Decision[]
  tasks          Task[]
  notifications  Notification[]
}

model Role {
  id          String   @id @default(cuid())
  name        String
  permissions Json
  users       User[]
}

// Communications & Collaboration
model CommsChannel {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  name           String
  slug           String
  type           String   @default("channel") // channel, direct, group
  isPrivate      Boolean  @default(false)
  topic          String?
  createdBy      String
  pinnedMetadata Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  members        CommsChannelMember[]
  messages       CommsMessage[]

  @@unique([organizationId, slug])
  @@index([organizationId, type])
}

model CommsChannelMember {
  id          String   @id @default(cuid())
  channelId   String
  channel     CommsChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  userId      String
  userName    String
  userAvatar  String?
  role        String   @default("member")
  isMuted     Boolean  @default(false)
  lastReadAt  DateTime?
  unreadCount Int      @default(0)
  joinedAt    DateTime @default(now())

  @@unique([channelId, userId])
  @@index([userId])
}

model CommsMessage {
  id             String   @id @default(cuid())
  channelId      String
  channel        CommsChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  authorId       String
  authorName     String
  authorAvatar   String?
  content        String
  attachments    Json?
  metadata       Json?
  isPinned       Boolean  @default(false)
  isRead         Boolean  @default(false)
  threadParentId String?
  threadParent   CommsMessage? @relation("CommsThread", fields: [threadParentId], references: [id])
  threadMessages CommsMessage[] @relation("CommsThread")
  reactions      CommsReaction[]
  editedAt       DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([channelId, createdAt])
  @@index([threadParentId])
}

model CommsReaction {
  id        String   @id @default(cuid())
  messageId String
  message   CommsMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  emoji     String
  userId    String
  userName  String
  createdAt DateTime @default(now())

  @@unique([messageId, emoji, userId])
  @@index([messageId])
}

// Inventory Management
model Inventory {
  id             String   @id @default(cuid())
  sku            String
  name           String
  description    String?
  quantity       Int
  reorderPoint   Int
  reorderQty     Int
  unit           String
  location       String
  warehouseId    String
  warehouse      Warehouse @relation(fields: [warehouseId], references: [id])
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  facilityId     String?
  facility       Facility? @relation(fields: [facilityId], references: [id])
  uom            String   @default("EA")
  quantityOnHand Float    @default(0)
  quantityOnHold Float    @default(0)
  qaState        String   @default("released")
  
  // QA fields
  qaStatus       String   @default("approved") // approved, qa_hold, rejected
  qaHoldReason   String?
  qaTests        Json?
  
  // Tracking
  lastUpdated    DateTime @updatedAt
  expiryDate     DateTime?
  batchNumber    String?
  temperature    Json?    // For cold chain
  
  movements      InventoryMovement[]
  qaHolds        QAHold[]
  
  @@unique([sku, warehouseId])
  @@index([organizationId, warehouseId])
  @@index([qaStatus])
  @@index([facilityId])
}

model InventoryMovement {
  id          String   @id @default(cuid())
  inventoryId String
  inventory   Inventory @relation(fields: [inventoryId], references: [id])
  type        String   // inbound, outbound, adjustment, transfer
  quantity    Int
  fromLocation String?
  toLocation   String?
  reference    String?  // PO number, SO number, etc
  reason       String?
  performedBy  String
  timestamp    DateTime @default(now())
  
  @@index([inventoryId, timestamp])
}

model QAHold {
  id          String   @id @default(cuid())
  inventoryId String
  inventory   Inventory @relation(fields: [inventoryId], references: [id])
  batchNumber String
  holdDate    DateTime @default(now())
  tests       Json     // Test results
  status      String   // pending, approved, rejected
  decision    String?
  decidedBy   String?
  decidedAt   DateTime?
  aiRecommendation Json?
  confidence  Float?
  
  @@index([status, holdDate])
}

// Production Management
model Production {
  id             String   @id @default(cuid())
  orderNumber    String   @unique
  productSku     String
  quantity       Int
  status         String   // planned, in_progress, completed, on_hold
  startDate      DateTime
  endDate        DateTime?
  lineId         String
  line           ProductionLine @relation(fields: [lineId], references: [id])
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  bom            Json
  actualOutput   Int?
  qualityScore   Float?
  efficiency     Float?
  
  tasks          ProductionTask[]
  
  @@index([status, startDate])
  @@index([organizationId, lineId])
}

model ProductionLine {
  id          String   @id @default(cuid())
  name        String
  type        String
  capacity    Int      // units per hour
  status      String   // active, maintenance, idle
  oee         Float?   // Overall Equipment Effectiveness
  currentJob  String?
  
  productions Production[]
  maintenance MaintenanceRecord[]
}

model ProductionTask {
  id           String   @id @default(cuid())
  productionId String
  production   Production @relation(fields: [productionId], references: [id])
  taskName     String
  sequence     Int
  status       String   // pending, in_progress, completed
  startTime    DateTime?
  endTime      DateTime?
  operatorId   String?
  notes        String?
  
  @@index([productionId, sequence])
}

// Procurement Management
model Procurement {
  id             String   @id @default(cuid())
  poNumber       String   @unique
  supplierId     String
  supplier       Supplier @relation(fields: [supplierId], references: [id])
  status         String   // draft, sent, confirmed, received, cancelled
  orderDate      DateTime @default(now())
  expectedDate   DateTime
  items          Json     // Array of line items
  totalAmount    Float
  currency       String   @default("USD")
  terms          String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  approvals      ProcurementApproval[]
  receipts       GoodsReceipt[]
  
  @@index([status, orderDate])
  @@index([organizationId, supplierId])
}

model Supplier {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  category    String
  rating      Float?
  leadTime    Int      // days
  paymentTerms String
  contact     Json
  compliance  Json?    // Certifications, audits
  performance Json?    // Delivery, quality metrics
  tenantId    String?
  tenant      Tenant?  @relation(fields: [tenantId], references: [id])
  
  procurements Procurement[]
  purchaseOrders PurchaseOrder[]

  @@index([tenantId])
}

// Project Management
model Project {
  id             String   @id @default(cuid())
  name           String
  description    String?
  status         String   // planning, active, on_hold, completed
  priority       String   // low, medium, high, critical
  startDate      DateTime
  endDate        DateTime
  budget         Float?
  actualCost     Float?
  progress       Float    @default(0)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  // Links to operations
  linkedOperations Json?  // Array of linked inventory, production, etc IDs
  
  tasks          Task[]
  decisions      Decision[]
  
  @@index([status, priority])
  @@index([organizationId])
}

model Task {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  title       String
  description String?
  status      String   // todo, in_progress, done
  priority    String
  assigneeId  String?
  assignee    User?    @relation(fields: [assigneeId], references: [id])
  dueDate     DateTime?
  completedAt DateTime?
  
  dependencies Json?   // Array of task IDs
  
  @@index([projectId, status])
  @@index([assigneeId])
}

// Decision Management
model Decision {
  id             String   @id @default(cuid())
  title          String
  description    String
  type           String   // procurement, qa_release, production, strategic
  status         String   // pending, approved, rejected, deferred
  priority       String   // low, medium, high, critical
  requesterId    String
  requester      User     @relation(fields: [requesterId], references: [id])
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  projectId      String?
  project        Project? @relation(fields: [projectId], references: [id])
  
  // Decision data
  context        Json
  alternatives   Json
  criteria       Json
  
  // Noise detection
  noiseFactors   Json?
  biasDetected   Boolean @default(false)
  
  // AI recommendation
  aiRecommendation Json?
  aiConfidence     Float?
  
  // Decision outcome
  choice         String?
  reasoning      String?
  decidedBy      String?
  decidedAt      DateTime?
  
  createdAt      DateTime @default(now())
  deadline       DateTime?
  
  @@index([status, priority])
  @@index([organizationId])
}

// Agent Management
model Agent {
  id             String   @id @default(cuid())
  name           String
  type           String   // inventory, qa, production, logistics, decision
  status         String   // active, idle, error, maintenance
  mode           String   // autonomous, supervised, training
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  configuration  Json
  permissions    Json
  metrics        Json?    // Performance metrics
  
  lastAction     String?
  lastActionTime DateTime?
  
  activities     AgentActivity[]
  
  @@index([organizationId, type, status])
}

model AgentActivity {
  id          String   @id @default(cuid())
  agentId     String
  agent       Agent    @relation(fields: [agentId], references: [id])
  action      String
  details     Json
  confidence  Float
  result      String?
  timestamp   DateTime @default(now())
  
  @@index([agentId, timestamp])
}

// Additional Models
model Warehouse {
  id             String   @id @default(cuid())
  code           String   @unique
  name           String
  type           String   // standard, cold_storage, hazmat
  address        Json
  capacity       Json     // Storage capacity details
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  inventories    Inventory[]
  zones          WarehouseZone[]
}

model Facility {
  id        String     @id @default(cuid())
  name      String
  code      String     @unique
  timezone  String     @default("UTC")
  address   Json?
  inventories Inventory[]
}

model WarehouseZone {
  id          String   @id @default(cuid())
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  code        String
  type        String   // picking, storage, staging, shipping
  temperature String?  // For cold chain
  
  @@unique([warehouseId, code])
}

model MaintenanceRecord {
  id           String   @id @default(cuid())
  lineId       String
  line         ProductionLine @relation(fields: [lineId], references: [id])
  type         String   // preventive, corrective, emergency
  scheduledDate DateTime
  completedDate DateTime?
  duration     Int?     // minutes
  description  String
  cost         Float?
  
  @@index([lineId, scheduledDate])
}

model GoodsReceipt {
  id            String   @id @default(cuid())
  procurementId String
  procurement   Procurement @relation(fields: [procurementId], references: [id])
  receiptNumber String   @unique
  receivedDate  DateTime @default(now())
  items         Json     // Received items with quantities
  qaStatus      String   // pending, passed, failed
  notes         String?
  receivedBy    String
  
  @@index([procurementId])
}

model ProcurementApproval {
  id            String   @id @default(cuid())
  procurementId String
  procurement   Procurement @relation(fields: [procurementId], references: [id])
  level         Int      // Approval level (1, 2, 3)
  approverId    String
  status        String   // pending, approved, rejected
  comments      String?
  timestamp     DateTime @default(now())
  
  @@index([procurementId, level])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String   // alert, info, warning, error
  title     String
  message   String
  data      Json?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([userId, read])
}

model Tenant {
  id               String              @id @default(cuid())
  code             String              @unique
  name             String
  timezone         String              @default("UTC")
  baseCurrency     String              @default("USD")
  sapSystem        String?
  plants           Plant[]
  materials        Material[]
  suppliers        Supplier[]
  alerts           InventoryAlert[]
  forecasts        ForecastSnapshot[]
  stocks           MaterialStock[]
  purchaseOrders   PurchaseOrder[]
  materialDocuments MaterialDocument[]
  qualityLots      QualityLot[]
  handlingUnits    HandlingUnit[]
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
}

model Plant {
  id                String            @id @default(cuid())
  tenantId          String
  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  code              String
  name              String
  region            String?
  timezone          String            @default("UTC")
  storageLocations  StorageLocation[]
  materialStocks    MaterialStock[]
  materialBatches   MaterialBatch[]
  materialDocuments MaterialDocument[]
  qualityLots       QualityLot[]
  purchaseOrders    PurchaseOrder[]
  forecastSnapshots ForecastSnapshot[]
  alerts            InventoryAlert[]
  handlingUnits     HandlingUnit[]
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@unique([tenantId, code])
}

model StorageLocation {
  id              String   @id @default(cuid())
  plantId         String
  plant           Plant    @relation(fields: [plantId], references: [id], onDelete: Cascade)
  code            String
  description     String?
  temperatureBand String?
  capacity        Decimal?
  stocks          MaterialStock[]
  handlingUnits   HandlingUnit[]
  purchaseItems   PurchaseOrderItem[]
  materialDocuments MaterialDocument[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([plantId, code])
}

model Material {
  id                   String             @id @default(cuid())
  tenantId             String
  tenant               Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  materialNumber       String
  description          String
  materialGroup        String?
  baseUnit             String
  valuationClass       String?
  mrpType              String?
  abcIndicator         String?
  shelfLifeDays        Int?
  serializationRequired Boolean         @default(false)
  hazardClass          String?
  leadTimeDays         Int?
  netWeight            Decimal?
  stocks               MaterialStock[]
  batches              MaterialBatch[]
  purchaseItems        PurchaseOrderItem[]
  documents            MaterialDocument[]
  qualityLots          QualityLot[]
  forecasts            ForecastSnapshot[]
  handlingUnits        HandlingUnit[]
  alerts               InventoryAlert[]
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@unique([tenantId, materialNumber])
}

model MaterialBatch {
  id               String   @id @default(cuid())
  materialId       String
  material         Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  plantId          String?
  plant            Plant?   @relation(fields: [plantId], references: [id])
  batchNumber      String
  manufacturingDate DateTime?
  expiryDate       DateTime?
  status           String   @default("OPEN")
  characteristics  Json?
  stocks           MaterialStock[]
  documents        MaterialDocument[]
  qualityLots      QualityLot[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([materialId, batchNumber])
}

model MaterialStock {
  id                String           @id @default(cuid())
  tenantId          String
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  materialId        String
  material          Material         @relation(fields: [materialId], references: [id], onDelete: Cascade)
  plantId           String
  plant             Plant            @relation(fields: [plantId], references: [id], onDelete: Cascade)
  storageLocationId String?
  storageLocation   StorageLocation? @relation(fields: [storageLocationId], references: [id])
  batchId           String?
  batch             MaterialBatch?   @relation(fields: [batchId], references: [id])
  uom               String
  availableQty      Decimal          @default(0)
  qualityQty        Decimal          @default(0)
  blockedQty        Decimal          @default(0)
  safetyStock       Decimal          @default(0)
  reorderPoint      Decimal          @default(0)
  status            String           @default("released")
  agingBucket       String?
  lastCountAt       DateTime?
  lastMovementAt    DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([tenantId, plantId, materialId])
  @@unique([tenantId, plantId, storageLocationId, materialId, batchId])
}

model PurchaseOrder {
  id             String         @id @default(cuid())
  tenantId       String
  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplierId     String
  supplier       Supplier       @relation(fields: [supplierId], references: [id])
  plantId        String?
  plant          Plant?         @relation(fields: [plantId], references: [id])
  documentNumber String         @unique
  status         String         @default("OPEN")
  incoterms      String?
  expectedDate   DateTime?
  currency       String?
  items          PurchaseOrderItem[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model PurchaseOrderItem {
  id               String        @id @default(cuid())
  purchaseOrderId  String
  purchaseOrder    PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  lineNumber       Int
  materialId       String
  material         Material      @relation(fields: [materialId], references: [id], onDelete: Cascade)
  orderedQty       Decimal
  receivedQty      Decimal        @default(0)
  uom              String
  netPrice         Decimal?
  currency         String?
  deliveryDate     DateTime?
  status           String         @default("OPEN")
  storageLocationId String?
  storageLocation  StorageLocation? @relation(fields: [storageLocationId], references: [id])
  batchRequirement Boolean        @default(false)
  confirmedDate    DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@unique([purchaseOrderId, lineNumber])
}

model MaterialDocument {
  id               String           @id @default(cuid())
  tenantId         String
  tenant           Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  documentNumber   String           @unique
  movementType     String
  materialId       String
  material         Material         @relation(fields: [materialId], references: [id], onDelete: Cascade)
  batchId          String?
  batch            MaterialBatch?   @relation(fields: [batchId], references: [id])
  plantId          String
  plant            Plant            @relation(fields: [plantId], references: [id], onDelete: Cascade)
  storageLocationId String?
  storageLocation  StorageLocation? @relation(fields: [storageLocationId], references: [id])
  quantity         Decimal
  uom              String
  reference        String?
  reasonCode       String?
  source           String?
  postedBy         String?
  postedAt         DateTime @default(now())
  metadata         Json?
}

model QualityLot {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plantId     String
  plant       Plant    @relation(fields: [plantId], references: [id], onDelete: Cascade)
  materialId  String
  material    Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  batchId     String?
  batch       MaterialBatch? @relation(fields: [batchId], references: [id])
  inspectionType String?
  status      String   @default("PENDING")
  holdReason  String?
  releasedQty Decimal  @default(0)
  rejectedQty Decimal  @default(0)
  inspector   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId, status])
}

model HandlingUnit {
  id               String           @id @default(cuid())
  tenantId         String
  tenant           Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  huNumber         String
  plantId          String?
  plant            Plant?           @relation(fields: [plantId], references: [id])
  storageLocationId String?
  storageLocation  StorageLocation? @relation(fields: [storageLocationId], references: [id])
  materialId       String?
  material         Material?        @relation(fields: [materialId], references: [id])
  quantity         Decimal?
  uom              String?
  weightKg         Decimal?
  status           String           @default("IDLE")
  metadata         Json?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@unique([tenantId, huNumber])
}

model ForecastSnapshot {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  materialId  String
  material    Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  plantId     String?
  plant       Plant?   @relation(fields: [plantId], references: [id])
  horizon     String
  method      String
  payload     Json
  generatedAt DateTime @default(now())
}

model InventoryAlert {
  id            String   @id @default(cuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  materialId    String?
  material      Material? @relation(fields: [materialId], references: [id])
  plantId       String?
  plant         Plant?   @relation(fields: [plantId], references: [id])
  alertType     String
  severity      String   @default("medium")
  message       String
  source        String?
  acknowledged  Boolean  @default(false)
  createdAt     DateTime @default(now())
  resolvedAt    DateTime?

  @@index([tenantId, alertType])
}

model Document {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  type        String
  size        Int
  hash        String
  storageUrl  String
  uploadedBy  String
  status      String   @default("processing")
  category    String?
  tags        String[]
  aiExtracted Json?
  compliance  Json?
  version     Int      @default(1)
  locked      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, hash])
  @@index([tenantId, status])
}

model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  action    String
  entity    String
  entityId  String
  details   Json
  createdAt DateTime @default(now())

  @@index([tenantId, action])
}

model AgentHeartbeat {
  id         String   @id @default(cuid())
  agentName  String
  queueName  String
  status     String
  payload    Json
  createdAt  DateTime @default(now())
}
